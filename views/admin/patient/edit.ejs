<%- include('../partials/head') %>

<body>
  <main class="admin-panel">
    <%- include('../partials/sidebar') %>
    </div>
    <div class="content">
      <div class="row">
        <div class="col-11">
          <h1>Welcome, Admin!</h1>
          <p>This is the admin panel for the patient management system.</p>
        </div>
        <div class="col-1">
          <a href="/logout" class="btn btn-danger">Logout</a>
        </div>
      </div>
      <div class="block">
        <div id="content">
          <h1 class="text-center">Update Details Of Patient <%= patient.firstName %> <%= patient.lastName %></h1>
          <% if (error) { %>
            <div class="alert alert-danger">
                <%= error %>
            </div>
            <% } %>

          <form action="/admin/patient/<%= patient.id %>?_method=PUT" method="POST" novalidate
            class="validated-form">
            <div class="d-flex justify-content-around">
              <div class="col-5">
                <div class="mb-3">
                  <label for="firstName" class="form-label">First Name:</label>
                  <input type="text" id="firstName" class="form-control" name="patient[firstName]"
                    value="<%= patient.firstName %>" required>
                  <div class="valid-feedback">
                    Looks Good!
                  </div>
                </div>

                <div class="mb-3">
                  <label for="lastName" class="form-label">Last Name:</label>
                  <input type="text" id="lastName" class="form-control" name="patient[lastName]"
                    value="<%= patient.lastName %>" required>
                  <div class="valid-feedback">
                    Looks Good!
                  </div>
                </div>

                <div class="mb-3">
                  <label for="dateOfBirth" class="form-label">Date of Birth:</label>
                  <input type="date" id="dateOfBirth" name="patient[dateOfBirth]"
                    value="<%= patient.dateOfBirth.toISOString().split('T')[0] %>" class="form-control" required>
                  <div class="valid-feedback">
                    Looks Good!
                  </div>
                </div>
                <div class="md-3">
                  <label for="gender" class="form-label">Gender:</label>
                  <select id="gender" name="patient[gender]" class="form-control" required>
                    <option value="Male" <% if (patient.gender === 'Male') { %> selected <% } %>>Male</option>
                    <option value="Female" <% if (patient.gender === 'Female') { %> selected <% } %>>Female</option>
                    <option value="Other" <% if (patient.gender === 'Other') { %> selected <% } %>>Other</option>
                  </select>
                  <div class="valid-feedback">
                    Looks Good!
                  </div>
                </div>
                <div class="md-3">
                  <label for="contactNumber" class="form-label">Contact Number:</label>
                  <input type="text" id="contactNumber" name="patient[contactNumber]"
                    value="<%= patient.contactNumber %>" required class="form-control">
                  <div class="valid-feedback">
                    Looks Good!
                  </div>
                </div>
                <div class="mb-3">
                  <label for="email" class="form-label">Email:</label>
                  <input type="email" id="email" name="patient[email]" class="form-control"
                    value="<%= patient.email %>" required disabled>
                  <div class="valid-feedback">
                    Looks Good!
                  </div>
                </div>
                <div class="mb-3">
                  <label for="nic" class="form-label">NIC:</label>
                  <input type="text" id="nic" name="patient[nic]" class="form-control" value="<%= patient.nic %>"
                    required disabled>
                  <div class="valid-feedback">
                    Looks Good!
                  </div>
                </div>
                <div class="mb-3">
                  <label for="number" class="form-label">Number:</label>
                  <input type="number" id="number" name="patient[address][number]"
                    value="<%= patient.address.number %>" class="form-control">
                  <div class="valid-feedback">
                    Looks Good!
                  </div>
                </div>
                <div class="mb-3">
                  <label for="street" class="form-label">Street:</label>
                  <input type="text" id="street" name="patient[address][street]" class="form-control"
                    value="<%= patient.address.street %>">
                  <div class="valid-feedback">
                    Looks Good!
                  </div>
                </div>
                <div class="mb-3">
                  <button type="button" id="deleteBtn" class="btn btn-danger form-control">Delete Patient</button>
                </div>
              </div>

              <div class="col-5">
                <div class="mb-3">
                  <label for="city" class="form-label">City:</label>
                  <input type="text" id="city" name="patient[address][city]" class="form-control"
                    value="<%= patient.address.city %>">
                  <div class="valid-feedback">
                    Looks Good!
                  </div>
                </div>
                <div class="mb-3">
                  <label for="state" class="form-label">State:</label>
                  <input type="text" id="state" name="patient[address][state]" class="form-control"
                    value="<%= patient.address.state %>">
                  <div class="valid-feedback">
                    Looks Good!
                  </div>
                </div>
                <div class="mb-3">
                  <label for="postalCode" class="form-label">Postal Code:</label>
                  <input type="number" id="postalCode" name="patient[address][postalCode]" class="form-control"
                    value="<%= patient.address.postalCode %>">
                  <div class="valid-feedback">
                    Looks Good!
                  </div>
                </div>
                <div class="mb-3">
                  <label for="medicalHistory.allergies" class="form-label">Allergies:</label>
                  <input type="text" id="allergies" name="patient[medicalHistory][allergies]" class="form-control"
                    value="<%= patient.medicalHistory.allergies.join(', ') %>">
                  <div class="valid-feedback">
                    Looks Good!
                  </div>
                </div>
                <div class="mb-3">
                  <label for="medicalHistory.conditions" class="form-label">Conditions:</label>
                  <input type="text" id="conditions" name="patient[medicalHistory][conditions]" class="form-control"
                    value="<%= patient.medicalHistory.conditions.join(', ') %>">
                  <div class="valid-feedback">
                    Looks Good!
                  </div>
                </div>
                <div class="mb-3">
                  <label for="medicalHistory.medications" class="form-label">Medications:</label>
                  <input type="text" id="medications" name="patient[medicalHistory][medications]" class="form-control"
                    value="<%= patient.medicalHistory.medications.join(', ') %>">
                  <div class="valid-feedback">
                    Looks Good!
                  </div>
                </div>
                <div class="mb-3">
                  <label for="emergencyContact.EmgName" class="form-label">Emergency Contact Name:</label>
                  <input type="text" id="emergencyContactName" name="patient[emergencyContact][EmgName]"
                    value="<%= patient.emergencyContact.EmgName %>" class="form-control">
                  <div class="valid-feedback">
                    Looks Good!
                  </div>
                </div>
                <div class="mb-3">
                  <label for="emergencyContact.EmgRelationship" class="form-label">Emergency Contact Relationship:</label>
                  <input type="text" id="emergencyContactRelationship" name="patient[emergencyContact][EmgRelationship]"
                    value="<%= patient.emergencyContact.EmgRelationship %>" class="form-control">
                  <div class="valid-feedback">
                    Looks Good!
                  </div>
                </div>
                <div class="mb-3">
                  <label for="emergencyContact.EmgContactNumber" class="form-label">Emergency Contact Number:</label>
                  <input type="text" id="emergencyContactNumber" name="patient[emergencyContact][EmgContactNumber]"
                    value="<%= patient.emergencyContact.EmgContactNumber %>" class="form-control">
                  <div class="valid-feedback">
                    Looks Good!
                  </div>
                </div>
                <div class="mb-3">
                  <button type="submit" class="btn btn-primary form-control">Update Patient Details</button>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </main>
  <script>

document.addEventListener('DOMContentLoaded', function () {
      const deleteBtn = document.getElementById('deleteBtn');

      if (deleteBtn) {
        deleteBtn.addEventListener('click', function () {
          // Confirm with the user if they really want to delete the patient
          const confirmDelete = confirm('Are you sure you want to delete this patient?');

          if (confirmDelete) {
            // If the user confirms, make an AJAX request to delete the patient
            const patientID = '<%= patient.id %>'; // You need to set this data attribute on the delete button
            fetch(`/admin/patient/${patientID}`, {
              method: 'DELETE',
            })
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  // Patient deleted successfully, redirect or show a success message
                  window.location.href = '/admin/patient'; // Redirect to the patient list page
                } else {
                  console.error(error)
                  alert('Failed to delete patient. Please try again later.');
                }
              })
              .catch(error => {
                console.error('Error deleting patient:', error);
                alert('An error occurred while deleting the patient.');
              });
          }
        });
      }
    });

    var toggleBtn = document.getElementById('toggleBtn');
    var content = document.getElementById('content');

    var overviewToggleBtn = document.getElementById('overviewToggleBtn');
    var Overview = document.getElementById('overview');

    toggleBtn.addEventListener('click', function () {
      if (content.classList.contains('hidden')) {
        Overview.classList.add('hidden');
        content.classList.remove('hidden');
      } else {
        content.classList.add('hidden');
      }
    });

    overviewToggleBtn.addEventListener('click', function () {
      if (Overview.classList.contains('hidden')) {
        content.classList.add('hidden');
        Overview.classList.remove('hidden');
      } else {
        Overview.classList.add('hidden');
      }
    });

  </script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"
    integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"
    integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF"
    crossorigin="anonymous"></script>
  <script src="/javascripts/boostrapFormValidation.js"></script>
  <script src="/javascripts/admin/admin.js"></script>
</body>

</html>
